#
#
#

.PHONY : msys win32 win64 linux android

PDIR   ?= libdir
VERSION = v0.9.60

system	:= $(shell uname -s)
system := $(shell echo $(system) | grep MINGW > /dev/null && echo MINGW || echo $(system))
ifeq ($(system), Darwin)
	TARGET ?= macos
	GENERATOR ?= -G Xcode
	PREFIX ?= /usr/local
	NATIVEPACK = macpack
else
ifeq ($(system), MINGW)
	TARGET ?= windows
	PDIR  ?= win64
	NATIVEPACK = winpack
else
ifeq ($(system), Linux)
	TARGET ?= linux
	PREFIX ?= /usr/local
	NATIVEPACK = linuxpack
else
	TARGET = linux
	NATIVEPACK = undefined
endif
endif
endif

IOS  := iosdir

CMAKEOPT ?=

TOOLS := LilyPondIssue34 Mikrokosmos3Wandering MusicAndHarmonies RandomChords RandomMusic countnotes displayMusicformatsHistory displayMusicformatsVersion msdlconverter partsummary readunrolled xml2brl xml2gmn xml2guido xml2ly xml2midi xml2xml xmlclone xmlfactory xmliter xmlread xmltranspose xmlversion

#	make submodule
all :
	make $(TARGET)

undefined:
	$(error System is undefined, not target available)

help :
	@echo MusicFormats makefile - Targets are :
	@echo "   all (default): build the MusicFormats library for the current platform,"
	@echo "                  build the MusicFormats tools,"
	@echo
	@echo "Platform targets to build the MusicFormats library are:"
	@echo "   macos     build the library for macos"
	@echo "   windows   build 32 and 64 bits library for windows"
	@echo "   linux     build the library for linux"
	@echo "   android   build a static library for Android"
	@echo "   ios       build a static library for iOS"
	@echo "   msys      build on Windows using MSys"
	@echo "   js        build a javascript library"
	@echo "the platform targets is automatically evaluated by the default target."
	@echo
	@echo "Misc:"
	@echo "   cmake     re-generates the cmake project"
	@echo "   format    source code formatting using clang-format"
	@echo "   install   install library, tools and headers"
	@echo "   localinstall   install the tools to ~/bin"
	@echo "   package   create the musicformats-$(VERSION) package"
	@echo
	@echo "Options:"
	@echo "   CMAKEOPT  cmake options passed to cmake by the 'cmake' target"
	@echo "   GENERATOR the cmake generator. Currently '$(GENERATOR)'"
	@echo "   PDIR      the generation folder. Currently '$(PDIR)'"
	@echo "   PREFIX    the install location prefix. Currently $(PREFIX)'"
	@echo
	@echo "CMake options:"
	@echo "   FMWK 		[MacOS only] Generates a framework on MacOS. Default is on"
	@echo "   GDB 		Activates ggdb3 option. Default is off"
	@echo "   LILY 		Include lilypond part. Default is on"
	@echo "NOTE:  CMake options can be passed using CMAKEOPT, e.g."
	@echo "      'make cmake CMAKEOPT=-DLILY=off'"


$(PDIR) :
	mkdir $(PDIR)

#===============================================================
# updating submodules
#===============================================================
submodule:
	git submodule update --init --recursive
	git -C ../libmusicxml checkout dev
	git -C ../libmusicxml pull origin dev


#===============================================================
# building the javascript library
#===============================================================
js:
	make -C ../javascript

#===============================================================
# building the library on Mac OS X
#===============================================================
macos : $(PDIR)/musicformats.xcodeproj
	cmake --build $(PDIR) --config Release
	-cd lib &&  [ -d musicformats.framework ] && tar czf musicformats.tgz musicformats.framework || echo "no framework"

$(PDIR)/musicformats.xcodeproj : $(PDIR) CMakeLists.txt
	cd $(PDIR) && cmake .. -G Xcode $(CMAKEOPT)  -Wno-dev


#===============================================================
# building the library for iOS
#===============================================================
ios : $(IOS)/musicformats.xcodeproj
	cmake --build $(IOS) --config Release

$(IOS)/musicformats.xcodeproj : CMakeLists.txt
	[ -d $(IOS) ] || mkdir $(IOS)
	cd $(IOS) && cmake .. -G Xcode -DIOS=yes -Wno-dev $(CMAKEOPT)


#===============================================================
# building the library on windows
#===============================================================

#===============================================================
# using msys
msys : GENERATOR ?= -G "MSYS Makefiles"
msys : $(PDIR)/Makefile
	make -C $(PDIR)

#===============================================================
# using visual studio
windows :
	make win32
	make win64

win32 : win32/musicformats.sln
	cmake --build win32 --config Release -- /maxcpucount:4

win32/musicformats.sln : CMakeLists.txt
	[ -d win32 ] || mkdir win32
	cd win32 && cmake .. $(GENERATOR) $(CMAKEOPT)

win64 : win64/musicformats.sln
	cmake --build win64 --config Release -- /maxcpucount:4

win64/musicformats.sln : CMakeLists.txt
	[ -d win64 ] || mkdir win64
	cd win64 && cmake .. $(GENERATOR) $(CMAKEOPT)

#===============================================================
# building the library on linux
#===============================================================
linux : $(PDIR)/Makefile
	cmake --build $(PDIR) --config Release

$(PDIR)/Makefile : $(PDIR) CMakeLists.txt
	cd $(PDIR) && cmake .. $(GENERATOR)  $(CMAKEOPT)


#===============================================================
cmake : $(PDIR)
	cd $(PDIR) && cmake .. $(GENERATOR) -Wno-dev $(CMAKEOPT)

#===============================================================
# building the library for Android
#===============================================================
android :
	ndk-build -C android -j 6
	cp android/libs/armeabi-v7a/musicformats.so android/musicformats.armeabi-v7a.so
	cp android/libs/x86/musicformats.so android/musicformats.x86.so

#===============================================================
# install
#===============================================================
installLog := $(PDIR)/install_manifest.txt
install:
	cd $(PDIR) && cmake .. -DCMAKE_INSTALL_PREFIX=$(PREFIX)
	cmake --build $(PDIR) --config Release --target install

uninstall: installedfiles = $(shell cat $(installLog))
uninstall: $(installLog)
	rm -f $(installedfiles) $(installLog)

localinstall:
	cd bin && cp $(TOOLS) $(HOME)/bin


#===============================================================
# packaging
#===============================================================
PACKDIR := ../packages
PACK := $(PACKDIR)/musicformats-$(VERSION)
package:
	$(MAKE) $(NATIVEPACK)

winpack:
	$(MAKE) win64
	cd win64 && cpack -G NSIS64
	mv win64/musicformats-*.exe .

macpack: $(PACKDIR)/README.html
	$(MAKE) cmake CMAKEOPT="-DLILY=on -DBRL=on -DFMWK=off"
	$(MAKE) macos
	-[ -d $(PACK) ] && rm -rf $(PACK)
	$(MAKE) install PREFIX=../$(PACK)
	hdiutil create $(PACK).dmg -fs HFS+ -srcfolder $(PACK) -format UDBZ -ov

linuxpack:
	@echo Linux packaging not implemented.

$(PACKDIR)/README.html: $(PACKDIR)/README.md
	echo "<!DOCTYPE html><html><xmp>" > $@
	cat $< >> $@
	echo "</xmp>" >> $@
	echo "<script src=http://strapdownjs.com/v/0.2/strapdown.js></script>" >> $@
	echo "</html>" >> $@
